# Database Migrations

This folder contains SQL migration files for the Flow Social Agents pipeline.

## Migration Files

Run these migrations **in order** on your Supabase database:

1. **001_create_projects.sql** - Creates `projects` table
2. **002_create_artifacts.sql** - Creates `artifacts` table
3. **003_create_jobs.sql** - Creates `jobs` table
4. **004_create_approvals.sql** - Creates `approvals` table
5. **005_create_runs.sql** - Creates `runs` table
6. **006_create_storage_bucket.sql** - Creates storage bucket and policies

## How to Apply

### Method 1: Supabase Dashboard

1. Go to your Supabase project dashboard
2. Navigate to SQL Editor
3. Open each migration file in order
4. Copy and paste the content
5. Click "Run"
6. Verify no errors before proceeding to next migration

### Method 2: Supabase CLI (if available)

```bash
supabase db push
```

### Method 3: Script (SQL file concatenation)

```bash
# Concatenate all migrations
cat migrations/*.sql > all_migrations.sql

# Run via psql or Supabase dashboard
```

## What Each Migration Does

### 001_create_projects.sql

- Creates `projects` table
- Adds indexes for efficient queries
- Enables RLS (Row Level Security)
- Creates policies for authenticated users

**Tables:** `projects`

### 002_create_artifacts.sql

- Creates `artifacts` table with foreign key to projects
- Supports multiple content types (text, JSON, files)
- Versioning support
- RLS policies

**Tables:** `artifacts`

### 003_create_jobs.sql

- Creates `jobs` table for tracking work
- Job statuses: queued, running, needs_approval, done, failed
- Links to input/output artifacts
- Auto-updating `updated_at` timestamp trigger

**Tables:** `jobs`

### 004_create_approvals.sql

- Creates `approvals` table
- Links artifacts to approval workflow
- Approval statuses: pending, approved, rejected
- Optional notes field

**Tables:** `approvals`

### 005_create_runs.sql

- Creates `runs` table for cost/token tracking
- Logs model usage, token counts, duration, cost estimates
- Links to jobs for audit trail

**Tables:** `runs`

### 006_create_storage_bucket.sql

- Creates `flow-artifacts` storage bucket
- Sets up RLS policies for file access
- Authenticated users can read/write

**Storage:** `flow-artifacts` bucket

## Verifying Migrations

After running all migrations, verify in Supabase Dashboard:

1. Go to Table Editor - you should see 5 new tables:
   - projects
   - artifacts
   - jobs
   - approvals
   - runs

2. Go to Storage - you should see:
   - flow-artifacts bucket

3. All tables should have RLS enabled (green shield icon)

## Rollback

To rollback migrations, you need to manually drop tables in reverse order:

```sql
-- Run in reverse order
DROP TABLE IF EXISTS runs CASCADE;
DROP TABLE IF EXISTS approvals CASCADE;
DROP TABLE IF EXISTS jobs CASCADE;
DROP TABLE IF EXISTS artifacts CASCADE;
DROP TABLE IF EXISTS projects CASCADE;

-- Remove storage bucket
DELETE FROM storage.buckets WHERE id = 'flow-artifacts';
```

⚠️ **Warning:** This will delete all data. Use only in development.

## Schema Diagram

```
projects
  └─── artifacts (FK: project_id)
       ├─── jobs (FK: input_artifact_id, output_artifact_id)
       │    └─── runs (FK: job_id)
       └─── approvals (FK: artifact_id)
```

## Notes

- All timestamps use `TIMESTAMPTZ` for timezone awareness
- All IDs are UUIDs generated by `gen_random_uuid()`
- RLS policies are permissive for now (authenticated users can access all)
- In production, tighten RLS to user-specific access
